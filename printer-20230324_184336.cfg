# This file contains common pin mappings for the 2019 Creality
# Ender 5. To use this config, the firmware should be compiled for the
# AVR atmega1284p.

# Modified by Zeanon

# Note, a number of Melzi boards are shipped with a bootloader that
# requires the following command to flash the board:
#  avrdude -p atmega1284p -c arduino -b 57600 -P /dev/ttyUSB0 -U out/klipper.elf.hex
# If the above command does not work and "make flash" does not work
# then one may need to flash a bootloader to the board - see the
# Klipper docs/Bootloaders.md file for more information.

# See docs/Config_Reference.md for a description of parameters.


[include include.cfg]
# [include fluidd.cfg]


[stepper_x]
step_pin: PD7
dir_pin: !PC5
enable_pin: !PD6
microsteps: 16
rotation_distance: 39.8
endstop_pin: ^PC2
position_endstop: 240
position_min: -12
position_max: 240
homing_speed: 30
homing_retract_dist: 10.0
homing_positive_dir: true

[stepper_y]
step_pin: PC6
dir_pin: !PC7
enable_pin: !PD6
microsteps: 16
rotation_distance: 39.8
endstop_pin: ^PC3
position_endstop: 223.0
position_min: -12.5
position_max: 227
homing_speed: 30
homing_retract_dist: 10.0
homing_positive_dir: true

[stepper_z]
step_pin: PB3
dir_pin: !PB2
enable_pin: !PA5
microsteps: 16
rotation_distance: 4 # Use 4 for Ender5 versions after late 2019
endstop_pin: ^PC4
position_endstop: 0.0
position_min: -5
position_max: 310
homing_speed: 10
homing_retract_dist: 5.0
homing_positive_dir: false

[extruder]
step_pin: PB1
dir_pin: PB0
enable_pin: !PD6
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 4.7283489
max_extrude_only_distance: 250
max_extrude_only_velocity: 120
max_extrude_only_accel: 3000
instantaneous_corner_velocity: 5.000
pressure_advance: 0.0515
pressure_advance_smooth_time: 0.03

heater_pin: PD5
# sensor_type: EPCOS 100K B57560G104F
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA7
control = pid
pid_kp = 16.119
pid_ki = 1.043
pid_kd = 62.259
min_temp: 0
max_temp: 300
min_extrude_temp: 190

nozzle_diameter: 0.400
filament_diameter: 1.750

[firmware_retraction]
retract_length: 1.25
retract_speed: 100 # Set to 30 when printing TPU
unretract_speed: 100 # Set to 30 when printing TPU

[heater_bed]
heater_pin: PD4
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA6
control = pid
pid_kp = 70.885
pid_ki = 1.591
pid_kd = 789.479
min_temp: 0
max_temp: 130

[fan]
pin: PB4

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

[probe]
pin: ~!rpi:gpio6
#   Probe detection pin. If the pin is on a different microcontroller
#   than the Z steppers then it enables "multi-mcu homing". This
#   parameter must be provided.
#deactivate_on_each_sample: True
#   This determines if Klipper should execute deactivation gcode
#   between each probe attempt when performing a multiple probe
#   sequence. The default is True.
x_offset: -2
#   The distance (in mm) between the probe and the nozzle along the
#   x-axis. The default is 0.
y_offset: 30
#   The distance (in mm) between the probe and the nozzle along the
#   y-axis. The default is 0.
#z_offset = 15.050
#   The distance (in mm) between the bed and the nozzle when the probe
#   triggers. This parameter must be provided.
#speed: 5.0
#   Speed (in mm/s) of the Z axis when probing. The default is 5mm/s.
#samples: 1
#   The number of times to probe each point. The probed z-values will
#   be averaged. The default is to probe 1 time.
#sample_retract_dist: 2.0
#   The distance (in mm) to lift the toolhead between each sample (if
#   sampling more than once). The default is 2mm.
lift_speed: 20
#   Speed (in mm/s) of the Z axis when lifting the probe between
#   samples. The default is to use the same value as the 'speed'
#   parameter.

[bed_mesh]
mesh_min: 8,17
mesh_max: 222,220
probe_count: 6,6
mesh_pps: 2,3
algorithm: bicubic
speed: 50
horizontal_move_z: 2.5

[display]
lcd_type: st7920
cs_pin: PA3
sclk_pin: PA1
sid_pin: PC1
encoder_pins: ^PD2, ^PD3
click_pin: ^!PC0

[input_shaper]
#shaper_type_x = 3hump_ei
#shaper_freq_x = 91.0
#shaper_type_y = ei
#shaper_freq_y = 53.6

# [save_variables]
# filename: ~/database.cfg
#   Required - provide a filename that would be used to save the
#   variables to disk e.g. ~/variables.cfg

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points:
    119.25, 111, 20

[temperature_sensor RASPBERRY_PI]
sensor_type: temperature_host
min_temp: 10
max_temp: 80

[output_pin BEEPER]
pin: PA4
pwm: True ; A piezo beeper needs a PWM signal, a DC buzzer doesn't.
value: 0 ; Silent at power on, set to 1 if active low.
shutdown_value: 0 ; Disable at emergency shutdown
cycle_time: 0.001 ; PWM frequency : 0.001 = 1ms will give a base tone of 1kHz
scale: 4000 ; PWM parameter will be in the range of (0-4000 Hz).

[output_pin LED]
pin: rpi:gpio21
value: 0

# [output_pin PROBE_PIN]
# pin: rpi:gpio5
# static_value: 1

[static_digital_output PROBE_PIN]
pins: rpi:gpio5

[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[force_move]
enable_force_move: true

[pause_resume]

[display_status]

[respond]

[gcode_arcs]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -2.088750, -2.160000, -2.271250, -2.337500, -2.290000, -2.443750
#*# 	  -2.115000, -2.200000, -2.235000, -2.462500, -2.903750, -3.478750
#*# 	  -2.142500, -2.165000, -2.248750, -2.633750, -2.492500, -2.998750
#*# 	  -2.185000, -2.216250, -2.245000, -2.336250, -2.557500, -2.658750
#*# 	  -2.246250, -2.241250, -2.328750, -2.393750, -2.516250, -2.516250
#*# 	  -2.305000, -2.341250, -2.390000, -2.436250, -2.565000, -2.697500
#*# tension = 0.2
#*# min_x = 8.01
#*# algo = bicubic
#*# y_count = 6
#*# mesh_y_pps = 3
#*# min_y = 20.0
#*# x_count = 6
#*# max_y = 215.0
#*# mesh_x_pps = 2
#*# max_x = 225.0
#*#
#*# [probe]
#*# z_offset = 0.770
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 49.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 53.2
