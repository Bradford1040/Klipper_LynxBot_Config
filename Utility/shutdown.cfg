[gcode_macro SHUTDOWN]
gcode:
  {action_call_remote_method("shutdown_machine")}

[gcode_macro SHUTDOWN_AFTER_PRINT]
variable_value: 0
gcode:
  {% if params.VALUE is not defined %}
    {% if printer['SHUTDOWN_AFTER_PRINT'].value|int == 0 %}
      {% set state = 1 %}
    {% else %}
      {% set state = 0 %}
    {% endif %}
  {% else %}
    {% set state = params.VALUE|int %}
  {% endif %}

  SET_GCODE_VARIABLE MACRO=SHUTDOWN_AFTER_PRINT VARIABLE=value value={state}

[delayed_gcode SHUTDOWN]
gcode:
  SHUTDOWN

[gcode_shell_command SHUTDOWN]
command: systemctl poweroff
timeout: 60.0
verbose: False
