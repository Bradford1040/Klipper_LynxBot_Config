[gcode_macro ADJUST_Z_TILT]
gcode:
  {% set FORCE = params.FORCE|default('TRUE')|string %}
  {% set STATUS_Z_TILT = printer['gcode_macro _HOMING_STATUS'].z_tilt %}

  {% if FORCE|upper == 'TRUE' or STATUS_Z_TILT|int != 1 %}
    LOCK_DOCKING

    {% if FORCE|upper == 'TRUE' %}
      G28 P0
    {% else %}
      G28 X0 Y0 Z0 P0
    {% endif %}

    Z_TILT_ADJUST

    UNLOCK_DOCKING

    G28 Z
  {% endif %}

[gcode_macro G32]
gcode:
  ADJUST_Z_TILT
    
  
[gcode_macro Z_TILT_ADJUST]
rename_existing: Z_TILT_ADJUST_BASE
gcode:
  {% set ACTUAL_TEMP = printer.heater_bed.temperature %}
  {% set TARGET_TEMP = printer.heater_bed.target %}

  {% if TARGET_TEMP > printer['gcode_macro _HOMING_VARIABLES'].max_probing_temp %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={printer['gcode_macro _HOMING_VARIABLES'].max_probing_temp}
    TEMPERATURE_WAIT SENSOR=heater_bed MAXIMUM={printer['gcode_macro _HOMING_VARIABLES'].max_probing_temp + 1}
  {% else %}
    {% if ACTUAL_TEMP > printer['gcode_macro _HOMING_VARIABLES'].max_probing_temp %}
      TEMPERATURE_WAIT SENSOR=heater_bed MAXIMUM={printer['gcode_macro _HOMING_VARIABLES'].max_probing_temp + 1}
    {% endif %}
  {% endif %}

  SET_GCODE_VARIABLE MACRO=_CACHED_MESH_DATABASE VARIABLE=cached_mesh VALUE="'{ printer.bed_mesh.profile_name }'"
  BED_MESH_CLEAR
    
  ATTACH_PROBE RETURN_TO_POSITION=FALSE

  Z_TILT_ADJUST_BASE {rawparams}

  SET_GCODE_VARIABLE MACRO=_HOMING_STATUS VARIABLE=z_tilt VALUE=1

  DOCK_PROBE RETURN_TO_POSITION=FALSE

  {% if TARGET_TEMP > printer['gcode_macro _HOMING_VARIABLES'].max_probing_temp %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={TARGET_TEMP}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={ACTUAL_TEMP}
  {% endif %}
      
  _LOAD_CACHED_MESH
