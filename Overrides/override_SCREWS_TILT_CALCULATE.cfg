[gcode_macro CALCULATE_SCREW_TILT]
gcode:
    {% set MAX_DEVIATION = params.MAX_DEVIATION|default(0.01)|float %}
    SCREWS_TILT_CALCULATE {% for p in params
        %}{'%s=%s ' % (p, params[p])}{%
        endfor %}

[gcode_macro FINALIZE_CALCULATE_SCREW_TILT]
gcode:
    SCREWS_TILT_CALCULATE_FINALIZE {% for p in params
        %}{'%s=%s ' % (p, params[p])}{%
        endfor %}

[gcode_macro SCREWS_TILT_CALCULATE]
rename_existing: SCREWS_TILT_CALCULATE_BASE
gcode:
    BED_MESH_CLEAR

    LOCK_DOCKING
    G28 PARK=FALSE

    ATTACH_PROBE RETURN_TO_POSITION=FALSE

    SCREWS_TILT_CALCULATE_BASE {% for p in params
            %}{'%s=%s ' % (p, params[p])}{%
            endfor %}

[gcode_macro SCREWS_TILT_CALCULATE_FINALIZE]
gcode:
  UNLOCK_DOCKING
  DOCK_PROBE RETURN_TO_POSITION=FALSE
  PARK
