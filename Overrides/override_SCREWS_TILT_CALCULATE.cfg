[gcode_macro CALCULATE_SCREW_TILT]
gcode:
    SCREWS_TILT_CALCULATE {% for p in params
        %}{'%s=%s ' % (p, params[p])}{%
        endfor %}

[gcode_macro FINALIZE_CALCULATE_SCREW_TILT]
gcode:
    SCREWS_TILT_CALCULATE_FINALIZE {% for p in params
        %}{'%s=%s ' % (p, params[p])}{%
        endfor %}

[gcode_macro SCREWS_TILT_CALCULATE]
rename_existing: SCREWS_TILT_CALCULATE_BASE
variable_adjusting: False
gcode:
    BED_MESH_CLEAR

    LOCK_DOCKING
    {% if not printer["gcode_macro SCREWS_TILT_CALCULATE"].adjusting %}
      SET_GCODE_VARIABLE MACRO=SCREWS_TILT_CALCULATE VARIABLE=adjusting VALUE={ True }
      G28 PARK=FALSE
    {% endif %}

    ATTACH_PROBE RETURN_TO_POSITION=FALSE

    SCREWS_TILT_CALCULATE_BASE {% for p in params
            %}{'%s=%s ' % (p, params[p])}{%
            endfor %}

[gcode_macro SCREWS_TILT_CALCULATE_FINALIZE]
gcode:
  SET_GCODE_VARIABLE MACRO=SCREWS_TILT_CALCULATE VARIABLE=adjusting VALUE={ False }
  UNLOCK_DOCKING
  DOCK_PROBE RETURN_TO_POSITION=FALSE
  PARK
