[gcode_macro NOTIFY_RUNOUT_MOTION]
gcode:
  M117 No Movement!
  RESPOND MSG="Filament Stopped Moving" color=error
  M300 A5

[gcode_macro NOTIFY_RUNOUT_SWITCH]
gcode:
  M117 No Filament!
  RESPOND MSG="No Filament Detected" color=error
  M300 A5


[gcode_macro ENABLE_FILAMENT_SENSOR]
description: Enable smart filament sensor
gcode:
    {% set ENABLE_MOTION_SENSOR = True %}
    
    {% set FILAMENT_TYPE = params.FILAMENT_TYPE|default('None')|string|upper %}
    {% set FILAMENT_PROFILE = params.FILAMENT_PROFILE|default('None')|string %}

    {% if FILAMENT_TYPE in printer["gcode_macro _RUNOUT_VARIABLES"].type or FILAMENT_PROFILE in printer["gcode_macro _RUNOUT_VARIABLES"].profile %}
      {% set ENABLE_MOTION_SENSOR = False %}
    {% endif %}

    RESPOND MSG="Enabling Filament Runout Sensor!" color=success
    G92 E0
    {% if ENABLE_MOTION_SENSOR %}
      SET_FILAMENT_SENSOR SENSOR=Motion ENABLE=1
    {% endif %}
    SET_FILAMENT_SENSOR SENSOR=Switch ENABLE=1

[gcode_macro ENABLE_FILAMENT_MOTION_SENSOR]
description: Enable filament motion sensor
gcode:
    RESPOND MSG="Enabling Filament Motion Sensor!" color=error
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=Motion ENABLE=1

[gcode_macro ENABLE_FILAMENT_SWITCH_SENSOR]
description: Enable filament switch sensor
gcode:
    RESPOND MSG="Enabling Filament Switch Sensor!" color=error
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=Switch ENABLE=1


[gcode_macro DISABLE_FILAMENT_SENSOR]
description: Disable smart filament sensor
gcode:
    RESPOND MSG="Disabling Filament Runout Sensor!" color=error
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=Motion ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=Switch ENABLE=0

[gcode_macro DISABLE_FILAMENT_MOTION_SENSOR]
description: Disable filament motion sensor
gcode:
    RESPOND MSG="Disabling Filament Motion Sensor!" color=error
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=Motion ENABLE=0

[gcode_macro DISABLE_FILAMENT_SWITCH_SENSOR]
description: Disable filament switch sensor
gcode:
    RESPOND MSG="Disabling Filament Switch Sensor!" color=error
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=Switch ENABLE=0


[delayed_gcode NOTIFY_RUNOUT_SWITCH]
gcode:
  M117 No Filament!
